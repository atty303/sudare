name: Release new version

permissions:
  contents: write

on: workflow_dispatch

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Calculate bumped version
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dry_run: true
      - name: Stop workflow if there hasn't been any new commit
        if: ${{ !steps.tag_version.outputs.new_tag }}
        run: exit 1
      - name: Bump version of Cargo.toml
        run: sed -i -e 's/^version = ".*"$/version = "${{ steps.tag_version.outputs.new_version }}"/' Cargo.toml
      - name: Update Cargo.lock
        run: cargo update -p sudare
      - name: Commit and tag the new version
        uses: EndBug/add-and-commit@v9
        with:
          add: Cargo.toml Cargo.lock
          message: Bump version to ${{ steps.tag_version.outputs.new_version }}
          tag: ${{ steps.tag_version.outputs.new_tag }}
      - name: Create a GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          name: ${{ steps.tag_version.outputs.new_version }}
          body: ${{ steps.tag_version.outputs.changelog }}
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}

  upload-assets:
    needs: create_release
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2.2.0
      - uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: sudare
          target: ${{ matrix.target }}
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: refs/tags/${{ needs.create_release.outputs.new_tag }}
