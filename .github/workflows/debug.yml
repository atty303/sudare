name: Debug

on: workflow_dispatch

jobs:
#  debug:
#    runs-on: macos-latest
#    steps:
#      - uses: actions/checkout@v3
#      - name: Setup tmate session
#        uses: mxschmitt/action-tmate@v3

  build:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2.2.0
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --target ${{ matrix.target }}
      - name: Create archive
        id: archive
        run: |
          project=sudare
          target_dir="$(cargo metadata --format-version=1 --no-deps | jq -r .target_directory)/${{ matrix.target }}/release"
          archive="${project}-${{ matrix.target }}"
          archive_path="$(pwd)/${archive}.tar.gz"
          tempdir=$(mktemp -d)
          cp ${target_dir}/${project} ${tempdir}
          ( cd ${tempdir} && tar acf ${archive_path} ${project} )
          rm -rf $tempdir
          echo "archive_path=${archive_path}" >>$GITHUB_OUTPUT
      - name: Release
        id: upload_asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.archive.outputs.archive_path }}
          fail_on_unmatched_files: true
          tag_name: v0.1.4
          name: 0.1.4
      - run:
          echo ${{ steps.upload_asset.outputs.assets }}
        